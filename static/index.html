<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Benchmark Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .metric-value { font-family: monospace; font-weight: bold; }
        .loading { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1>üîê Crypto Benchmark Dashboard</h1>
            <button id="runBtn" class="btn btn-primary btn-lg" onclick="runBenchmarks()">
                üöÄ Run Benchmarks
            </button>
        </header>

        <div id="loading" class="alert alert-info loading">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            Running benchmarks... This may take a few seconds.
        </div>

        <div id="results" style="display: none;">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Benchmark Time</h5>
                            <p class="display-6" id="totalTime">0.00s</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title">Signatures Tested</h5>
                            <p class="display-6" id="sigCount">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center text-white bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">KEMs Tested</h5>
                            <p class="display-6" id="kemCount">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Signature Performance (Lower is Better)</div>
                        <div class="card-body">
                            <canvas id="sigChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">KEM Performance (Lower is Better)</div>
                        <div class="card-body">
                            <canvas id="kemChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tables -->
            <div class="card">
                <div class="card-header">Detailed Results</div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="sig-tab" data-bs-toggle="tab" data-bs-target="#sig" type="button" role="tab">Signatures</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="kem-tab" data-bs-toggle="tab" data-bs-target="#kem" type="button" role="tab">Key Exchange</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3" id="myTabContent">
                        <div class="tab-pane fade show active" id="sig" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover" id="sigTable">
                                    <thead>
                                        <tr>
                                            <th>Algorithm</th>
                                            <th>Operation</th>
                                            <th>Mean (Œºs)</th>
                                            <th>Min (Œºs)</th>
                                            <th>Max (Œºs)</th>
                                            <th>StdDev</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="kem" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover" id="kemTable">
                                    <thead>
                                        <tr>
                                            <th>Algorithm</th>
                                            <th>Operation</th>
                                            <th>Mean (Œºs)</th>
                                            <th>Min (Œºs)</th>
                                            <th>Max (Œºs)</th>
                                            <th>StdDev</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sigChartInstance = null;
        let kemChartInstance = null;

        async function runBenchmarks() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('runBtn').disabled = true;

            try {
                const response = await fetch('/api/benchmarks', { method: 'POST' });
                const data = await response.json();
                renderResults(data);
            } catch (error) {
                alert('Error running benchmarks: ' + error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('runBtn').disabled = false;
            }
        }

        function renderResults(data) {
            document.getElementById('results').style.display = 'block';
            document.getElementById('totalTime').innerText = data.total_time_secs.toFixed(2) + 's';
            document.getElementById('sigCount').innerText = new Set(data.signatures.map(x => x.name)).size;
            document.getElementById('kemCount').innerText = new Set(data.kem.map(x => x.name)).size;

            renderTable('sigTable', data.signatures);
            renderTable('kemTable', data.kem);

            renderCharts(data);
        }

        function renderTable(tableId, metrics) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            metrics.forEach(m => {
                const tr = document.createElement('tr');
                let details = '';
                for (const [key, value] of Object.entries(m.extra_info)) {
                    details += `<small class="text-muted d-block">${formatKey(key)}: ${value}</small>`;
                }

                tr.innerHTML = `
                    <td>${m.name}</td>
                    <td>${m.operation}</td>
                    <td class="metric-value">${m.mean_micros.toFixed(2)}</td>
                    <td>${m.min_micros.toFixed(2)}</td>
                    <td>${m.max_micros.toFixed(2)}</td>
                    <td>¬±${m.std_dev_micros.toFixed(2)}</td>
                    <td>${details}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatKey(key) {
            return key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function renderCharts(data) {
            const ctxSig = document.getElementById('sigChart').getContext('2d');
            const ctxKem = document.getElementById('kemChart').getContext('2d');

            // Prepare Data for Signatures (Sign vs Verify)
            const sigLabels = [...new Set(data.signatures.map(d => d.name))];
            const signData = sigLabels.map(l => data.signatures.find(d => d.name === l && d.operation.includes('Sign'))?.mean_micros || 0);
            const verifyData = sigLabels.map(l => data.signatures.find(d => d.name === l && d.operation.includes('Verify'))?.mean_micros || 0);

            if (sigChartInstance) sigChartInstance.destroy();
            sigChartInstance = new Chart(ctxSig, {
                type: 'bar',
                data: {
                    labels: sigLabels,
                    datasets: [
                        { label: 'Sign (Œºs)', data: signData, backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                        { label: 'Verify (Œºs)', data: verifyData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }
                    ]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Microseconds' } } } }
            });

            // Prepare Data for KEM (Encaps vs Decaps or Key Exchange)
            const kemLabels = [...new Set(data.kem.map(d => d.name))];
            const kemData1 = kemLabels.map(l => data.kem.find(d => d.name === l && (d.operation.includes('Encapsulate') || d.operation.includes('Key Exchange')))?.mean_micros || 0);
            const kemData2 = kemLabels.map(l => data.kem.find(d => d.name === l && (d.operation.includes('Decapsulate')))?.mean_micros || 0);

            // Note: For DH/ECDH, we only have one op "Key Exchange" which is effectively shared secret gen.
            // So the second dataset might be empty for them.

            if (kemChartInstance) kemChartInstance.destroy();
            kemChartInstance = new Chart(ctxKem, {
                type: 'bar',
                data: {
                    labels: kemLabels,
                    datasets: [
                        { label: 'Encaps / Exchange (Œºs)', data: kemData1, backgroundColor: 'rgba(255, 99, 132, 0.6)' },
                        { label: 'Decapsulate (Œºs)', data: kemData2, backgroundColor: 'rgba(153, 102, 255, 0.6)' }
                    ]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Microseconds' } } } }
            });
        }
    </script>
</body>
</html>
